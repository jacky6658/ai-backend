<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AIJob 管理後台</title>
  <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #1f2937;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .nav {
            background: #374151;
            padding: 0;
        }
        .nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }
        .nav li {
            flex: 1;
        }
        .nav a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            text-align: center;
            transition: background 0.3s;
        }
        .nav a:hover, .nav a.active {
            background: #4b5563;
        }
        .content {
            padding: 30px;
        }
        .card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn-danger {
            background: #ef4444;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3b82f6;
        }
        .stat-label {
            color: #6b7280;
            margin-top: 5px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th, .table td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: left;
        }
        .table th {
            background: #f9fafb;
            font-weight: 600;
        }
        .hidden {
            display: none;
        }
        
        /* iOS Safari 優化 */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* 允許文字選擇 */
        input, textarea, .table td, .stat-number, .stat-label {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* 防止 iOS Safari 縮放 */
        input[type="text"], input[type="email"], input[type="password"], select, textarea {
            font-size: 16px;
            -webkit-appearance: none;
            border-radius: 0;
        }
        
        /* 移動端響應式設計 */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
                -webkit-text-size-adjust: 100%;
            }
            
            .container {
                margin: 0;
                border-radius: 0;
                box-shadow: none;
                min-height: 100vh;
            }
            
            .header {
                padding: 15px;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .header h1 {
                font-size: 1.2em;
                margin: 0;
            }
            
            .header p {
                font-size: 0.9em;
                margin: 5px 0 0 0;
            }
            
            .nav {
                position: sticky;
                top: 0;
                z-index: 99;
            }
            
            .nav ul {
                flex-direction: column;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav li {
                flex: none;
                min-width: 120px;
            }
            
            .nav a {
                padding: 12px 15px;
                font-size: 0.9em;
                white-space: nowrap;
                border-bottom: 1px solid #4b5563;
            }
            
            .content {
                padding: 15px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-number {
                font-size: 1.5em;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .table {
                font-size: 0.8em;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                display: block;
                white-space: nowrap;
            }
            
            .table thead, .table tbody, .table tr {
                display: block;
            }
            
            .table th, .table td {
                display: inline-block;
                width: auto;
                min-width: 100px;
                padding: 8px;
                border: 1px solid #e5e7eb;
                margin: 1px;
            }
            
            .table th {
                background: #f9fafb;
                font-weight: 600;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 0.9em;
                margin: 3px;
                min-height: 44px; /* iOS 最小觸控區域 */
                -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            }
            
            .form-group input, .form-group select {
                padding: 12px;
                font-size: 16px; /* 防止 iOS 縮放 */
                min-height: 44px;
            }
            
            /* 移動端表格卡片式顯示 */
            .mobile-table {
                display: none;
            }
            
            .mobile-card {
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
            }
            
            .mobile-card-header {
                font-weight: 600;
                margin-bottom: 10px;
                padding-bottom: 8px;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .mobile-card-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                padding: 5px 0;
            }
            
            .mobile-card-label {
                font-weight: 500;
                color: #6b7280;
                flex: 1;
            }
            
            .mobile-card-value {
                flex: 2;
                text-align: right;
            }
        }
        
        /* 超小螢幕優化 */
        @media screen and (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            .nav a {
                padding: 10px 12px;
                font-size: 0.8em;
            }
            
            .content {
                padding: 10px;
            }
            
            .card {
                padding: 12px;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
        
        /* iOS Safari 特定優化 */
        @supports (-webkit-touch-callout: none) {
            .container {
                -webkit-overflow-scrolling: touch;
            }
            
            .nav ul {
                -webkit-overflow-scrolling: touch;
            }
            
            .table {
                -webkit-overflow-scrolling: touch;
            }
            
            /* 修復 iOS Safari 的 flexbox 問題 */
            .nav ul {
                display: -webkit-flex;
                display: flex;
            }
            
            .stats {
                display: -webkit-grid;
                display: grid;
            }
        }
        
        /* 深色模式支援 */
        @media (prefers-color-scheme: dark) {
            body {
                background: #1a1a1a;
                color: #ffffff;
            }
            
            .container {
                background: #2d2d2d;
            }
            
            .card {
                background: #3a3a3a;
                border-color: #4a4a4a;
            }
            
            .table th, .table td {
                border-color: #4a4a4a;
            }
            
            .table th {
                background: #3a3a3a;
            }
            
            .form-group input, .form-group select {
                background: #3a3a3a;
                border-color: #4a4a4a;
                color: #ffffff;
      }
    }
  </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
                    <h1>AIJob 短影音智能 - 管理後台</h1>
                    <p>系統管理與監控中心</p>
      </div>
                <button id="admin-logout-btn" onclick="adminLogout()" style="
                    background: #dc2626; 
                    color: white; 
                    border: none; 
                    padding: 8px 16px; 
                    border-radius: 4px; 
                    cursor: pointer;
                    font-size: 14px;
                ">登出</button>
      </div>
    </div>

        <nav class="nav">
            <ul>
                <li><a href="#" onclick="showSection('dashboard')" class="active">儀表板</a></li>
                <li><a href="#" onclick="showSection('users')">用戶管理</a></li>
                <li><a href="#" onclick="showSection('referrals')">推薦碼管理</a></li>
                <li><a href="#" onclick="showSection('credits')">點數管理</a></li>
                <li><a href="#" onclick="showSection('analytics')">數據分析</a></li>
                <li><a href="#" onclick="showSection('settings')">系統設定</a></li>
            </ul>
        </nav>

        <div class="content">
            <!-- 儀表板 -->
            <div id="dashboard" class="section">
                <h2>系統概覽</h2>
                <div class="stats">
      <div class="stat-card">
                        <div class="stat-number" id="totalUsers">-</div>
                        <div class="stat-label">總用戶數</div>
      </div>
      <div class="stat-card">
                        <div class="stat-number" id="totalRequests">-</div>
                        <div class="stat-label">總請求數</div>
      </div>
      <div class="stat-card">
                        <div class="stat-number" id="todayRequests">-</div>
                        <div class="stat-label">今日請求</div>
      </div>
      <div class="stat-card">
                        <div class="stat-number" id="activeUsers">-</div>
                        <div class="stat-label">活躍用戶</div>
      </div>
    </div>

                <div class="card">
                    <h3>最近活動</h3>
                    <div id="recentActivity">
                        <p>載入中...</p>
      </div>
        </div>
      </div>

            <!-- 用戶管理 -->
            <div id="users" class="section hidden">
                <h2>用戶管理</h2>
                <div class="card">
                    <h3>搜尋用戶</h3>
                    <div class="form-group">
                        <input type="text" id="userSearch" placeholder="輸入用戶ID、email或用戶名">
                        <button class="btn" onclick="searchUsers()">搜尋</button>
      </div>
        </div>
        
                <div class="card">
                    <h3>用戶列表</h3>
                    <table class="table" id="usersTable">
            <thead>
              <tr>
                                <th>用戶ID</th>
                                <th>Email</th>
                                <th>用戶名</th>
                                <th>點數</th>
                                <th>推薦碼</th>
                <th>註冊時間</th>
                <th>操作</th>
              </tr>
            </thead>
                        <tbody>
                            <tr>
                                <td colspan="7">載入中...</td>
                            </tr>
            </tbody>
          </table>
        </div>
      </div>

            <!-- 推薦碼管理 -->
            <div id="referrals" class="section hidden">
                <h2>推薦碼管理</h2>
                <div class="card">
                    <h3>推薦關係統計</h3>
                    <table class="table" id="referralsTable">
            <thead>
              <tr>
                                <th>推薦者</th>
                                <th>被推薦者</th>
                                <th>推薦碼</th>
                                <th>推薦時間</th>
              </tr>
            </thead>
                        <tbody>
                            <tr>
                                <td colspan="4">載入中...</td>
                            </tr>
            </tbody>
          </table>
        </div>
        
                <div class="card">
                    <h3>手動重置每月點數</h3>
                    <button class="btn" onclick="resetMonthlyCredits()">重置所有免費用戶點數為500</button>
      </div>
        </div>
        
            <!-- 點數管理 -->
            <div id="credits" class="section hidden">
                <h2>點數管理</h2>
                <div class="card">
                    <h3>用戶充值</h3>
                    <div class="form-group">
                        <label>用戶ID或Email:</label>
                        <input type="text" id="chargeUserId" placeholder="輸入用戶ID或email">
        </div>
                    <div class="form-group">
                        <label>充值點數:</label>
                        <input type="number" id="chargeAmount" placeholder="輸入充值點數">
      </div>
                    <div class="form-group">
                        <label>充值原因:</label>
                        <input type="text" id="chargeReason" placeholder="輸入充值原因">
      </div>
                    <button class="btn" onclick="addCredits()">立即充值</button>
        </div>
        
                <div class="card">
                    <h3>點數記錄</h3>
                    <table class="table" id="creditsTable">
            <thead>
              <tr>
                                <th>用戶ID</th>
                                <th>餘額</th>
                                <th>最後更新</th>
                <th>操作</th>
              </tr>
            </thead>
                        <tbody>
                            <tr>
                                <td colspan="4">載入中...</td>
                            </tr>
            </tbody>
          </table>
        </div>
      </div>

            <!-- 數據分析 -->
            <div id="analytics" class="section hidden">
                <h2>數據分析</h2>
                <div class="card">
                    <h3>使用統計</h3>
                    <div id="analyticsChart">
                        <p>圖表載入中...</p>
            </div>
            </div>
            </div>
        
            <!-- 系統設定 -->
            <div id="settings" class="section hidden">
                <h2>系統設定</h2>
                <div class="card">
                    <h3>API 設定</h3>
                    <div class="form-group">
                        <label>API Base URL:</label>
                        <input type="text" id="apiBase" value="https://aijobvideobackend.zeabur.app">
            </div>
                    <div class="form-group">
                        <label>Admin Token:</label>
                        <input type="password" id="adminToken" placeholder="管理員Token">
            </div>
                    <button class="btn" onclick="saveSettings()">儲存設定</button>
          </div>
            </div>
          </div>
        </div>
        
    <script>
        // 顯示指定區塊
        function showSection(sectionId) {
            // 隱藏所有區塊
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // 移除所有導航項目的active狀態
            document.querySelectorAll('.nav a').forEach(link => {
                link.classList.remove('active');
            });
            
            // 顯示選中的區塊
            document.getElementById(sectionId).classList.remove('hidden');
            
            // 設置選中的導航項目為active
            document.querySelector(`a[onclick="showSection('${sectionId}')"]`).classList.add('active');
            
            // 載入對應數據
            loadSectionData(sectionId);
        }

        // 載入區塊數據
        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'dashboard':
                    loadDashboard();
                    break;
            case 'users':
                loadUsers();
                break;
            case 'referrals':
                loadReferrals();
                break;
            case 'credits':
                loadCredits();
                break;
                case 'analytics':
                    loadAnalytics();
                    break;
            }
        }

        // 載入儀表板數據
        async function loadDashboard() {
            try {
                const response = await fetch('/admin/analytics', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                document.getElementById('totalUsers').textContent = data.total_users || 0;
                document.getElementById('totalRequests').textContent = data.total_requests || 0;
                document.getElementById('todayRequests').textContent = data.today_requests || 0;
                document.getElementById('activeUsers').textContent = data.active_users || 0;
            } catch (error) {
                console.error('載入儀表板數據失敗:', error);
            }
        }

        // 檢查管理員登入狀態
        async function checkAdminLogin() {
            try {
                const response = await fetch('/admin/users', {
                    credentials: 'include'
                });
                if (response.status === 403) {
                    showLoginModal();
                    return false;
                }
                return true;
            } catch (error) {
                console.error('檢查管理員登入失敗:', error);
                showLoginModal();
                return false;
            }
        }

        // 顯示登入模態視窗
        function showLoginModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                align-items: center; justify-content: center;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; width: 300px;">
                    <h3 style="margin: 0 0 20px 0;">管理員登入</h3>
                    <input type="text" id="adminUsername" placeholder="管理員帳號" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="password" id="adminPassword" placeholder="管理員密碼" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                    <button onclick="adminLogin()" style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">登入</button>
                    <div id="loginError" style="color: red; margin-top: 10px;"></div>
          </div>
            `;
            document.body.appendChild(modal);
        }

        // 管理員登入
        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.body.removeChild(document.querySelector('div[style*="position: fixed"]'));
                    location.reload();
                } else {
                    errorDiv.textContent = data.message || '登入失敗';
                }
            } catch (error) {
                errorDiv.textContent = '登入失敗: ' + error.message;
            }
        }

        // 管理員登出
        async function adminLogout() {
            try {
                const response = await fetch('/admin/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showToast('已登出', 'success');
                    location.reload();
                } else {
                    showToast('登出失敗', 'error');
                }
            } catch (error) {
                console.error('登出失敗:', error);
                showToast('登出失敗: ' + error.message, 'error');
            }
        }

        // 簡單的提示函數
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                padding: 12px 20px; border-radius: 4px; color: white;
                background: ${type === 'success' ? '#10b981' : '#ef4444'};
                font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // 載入用戶數據
        async function loadUsers() {
            try {
                const response = await fetch('/admin/users', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('JSON解析失敗:', parseError);
                    console.error('響應內容:', text);
                    throw new Error('服務器返回的不是有效的JSON格式');
                }
                
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';
                
                if (data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.user_id}</td>
                            <td>${user.email || '-'}</td>
                            <td>${user.name || '-'}</td>
                            <td>${user.credits || 0}</td>
                            <td>${user.referral_code || '-'}</td>
                            <td>${user.created_at || '-'}</td>
                            <td>
                                <button class="btn" onclick="viewUser('${user.user_id}')">查看</button>
                                <button class="btn btn-danger" onclick="resetPassword('${user.user_id}')">重設密碼</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7">無用戶數據</td></tr>';
                }
            } catch (error) {
                console.error('載入用戶數據失敗:', error);
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '<tr><td colspan="7">載入失敗: ' + error.message + '</td></tr>';
            }
        }

        // 載入推薦碼數據
        async function loadReferrals() {
            try {
                const response = await fetch('/admin/referrals', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                const tbody = document.querySelector('#referralsTable tbody');
                tbody.innerHTML = '';
                
                if (data.referrals && data.referrals.length > 0) {
                    data.referrals.forEach(ref => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${ref.referrer_name || ref.referrer_id}</td>
                            <td>${ref.referred_name || ref.referred_id}</td>
                            <td>${ref.referral_code}</td>
                            <td>${ref.created_at || '-'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4">無推薦數據</td></tr>';
                }
            } catch (error) {
                console.error('載入推薦碼數據失敗:', error);
            }
        }

        // 重置每月點數
        async function resetMonthlyCredits() {
            if (!confirm('確定要重置所有免費用戶點數為500嗎？')) {
                return;
            }
            
            try {
                const response = await fetch('/admin/reset-monthly-credits', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.ok) {
                    alert('每月點數重置成功！');
                    loadUsers(); // 重新載入用戶數據
                } else {
                    alert('重置失敗：' + (data.error || '未知錯誤'));
                }
            } catch (error) {
                console.error('重置點數失敗:', error);
                alert('重置失敗：' + error.message);
            }
        }

        // 載入點數數據
        async function loadCredits() {
            try {
                const response = await fetch('/admin/users_full', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                const tbody = document.querySelector('#creditsTable tbody');
                tbody.innerHTML = '';
                
                if (data.credits && data.credits.length > 0) {
                    data.credits.forEach(credit => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${credit.user_id}</td>
                            <td>${credit.balance}</td>
                            <td>${credit.updated_at || '-'}</td>
                            <td>
                                <button class="btn" onclick="viewUserCredits('${credit.user_id}')">查看詳情</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4">無點數數據</td></tr>';
                }
            } catch (error) {
                console.error('載入點數數據失敗:', error);
            }
        }

        // 載入分析數據
        async function loadAnalytics() {
            document.getElementById('analyticsChart').innerHTML = '<p>分析圖表功能開發中...</p>';
        }

        // 搜尋用戶
        function searchUsers() {
            const query = document.getElementById('userSearch').value;
            if (query) {
                // 實作搜尋邏輯
                console.log('搜尋用戶:', query);
            }
        }

        // 添加點數
        async function addCredits() {
            const userId = document.getElementById('chargeUserId').value;
            const amount = document.getElementById('chargeAmount').value;
            const reason = document.getElementById('chargeReason').value;
            
            if (!userId || !amount || !reason) {
                alert('請填寫完整信息');
                return;
            }
            
            try {
                const response = await fetch('/admin/user/add_credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        identifier: userId,
                        credits: parseInt(amount),
                        reason: reason
                    })
                });
                
                const result = await response.json();
                if (response.ok) {
                    alert('充值成功！');
                    loadCredits(); // 重新載入點數數據
                } else {
                    alert('充值失敗: ' + (result.message || '未知錯誤'));
                }
            } catch (error) {
                console.error('充值失敗:', error);
                alert('充值失敗: ' + error.message);
            }
        }

        // 查看用戶
        function viewUser(userId) {
            console.log('查看用戶:', userId);
            // 實作查看用戶詳情邏輯
        }

        // 重設密碼
        function resetPassword(userId) {
            const newPassword = prompt('請輸入新密碼:');
            if (newPassword && newPassword.length >= 6) {
                // 實作重設密碼邏輯
                console.log('重設密碼:', userId, newPassword);
            } else {
                alert('密碼長度至少6位');
            }
        }

        // 查看用戶點數詳情
        async function viewUserCredits(userId) {
            console.log('查看用戶點數詳情:', userId);
            
            try {
                // 獲取用戶點數詳情
                const response = await fetch(`/admin/user/credit_details/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('獲取用戶點數詳情失敗');
                }
                
                const data = await response.json();
                showCreditDetailsModal(userId, data);
                
            } catch (error) {
                console.error('獲取用戶點數詳情失敗:', error);
                alert('獲取用戶點數詳情失敗: ' + error.message);
            }
        }
        
        // 顯示點數詳情模態窗口
        function showCreditDetailsModal(userId, data) {
            // 創建模態窗口
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>用戶點數詳情 - ${userId}</h3>
                        <button class="close-btn" onclick="closeCreditDetailsModal()">&times;</button>
        </div>
                    <div class="modal-body">
                        <div class="credit-summary">
                            <div class="summary-item">
                                <span class="label">當前餘額:</span>
                                <span class="value">${data.balance || 0} 點</span>
      </div>
                            <div class="summary-item">
                                <span class="label">總充值:</span>
                                <span class="value">${data.total_charged || 0} 點</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">總消費:</span>
                                <span class="value">${data.total_consumed || 0} 點</span>
    </div>
  </div>

                        <div class="credit-transactions">
                            <h4>點數交易記錄</h4>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>時間</th>
                                            <th>類型</th>
                                            <th>功能</th>
                                            <th>點數</th>
                                            <th>餘額</th>
                                            <th>備註</th>
                                        </tr>
                                    </thead>
                                    <tbody id="credit-transactions-tbody">
                                        ${generateTransactionRows(data.transactions || [])}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加樣式
            const style = document.createElement('style');
            style.textContent = `
                .modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                }
                .modal-content {
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    max-width: 90%;
                    max-height: 90%;
                    overflow: hidden;
                }
                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-bottom: 1px solid #e5e7eb;
                    background: #f9fafb;
                }
                .modal-header h3 {
                    margin: 0;
                    color: #1f2937;
                }
                .close-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #6b7280;
                }
                .close-btn:hover {
                    color: #374151;
                }
                .modal-body {
                    padding: 20px;
                }
                .credit-summary {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin-bottom: 20px;
                }
                .summary-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 10px;
                    background: #f3f4f6;
                    border-radius: 6px;
                }
                .summary-item .label {
                    font-weight: 500;
                    color: #374151;
                }
                .summary-item .value {
                    font-weight: 600;
                    color: #1f2937;
                }
                .credit-transactions h4 {
                    margin: 0 0 15px 0;
                    color: #1f2937;
                }
                .table-container {
                    overflow-x: auto;
                }
                .data-table {
                    width: 100%;
                    border-collapse: collapse;
                }
                .data-table th,
                .data-table td {
                    padding: 8px 12px;
                    text-align: left;
                    border-bottom: 1px solid #e5e7eb;
                }
                .data-table th {
                    background: #f9fafb;
                    font-weight: 600;
                    color: #374151;
                }
                .data-table td {
                    color: #1f2937;
                }
                .transaction-type {
                    padding: 2px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: 500;
                }
                .transaction-type.charge {
                    background: #dcfce7;
                    color: #166534;
                }
                .transaction-type.consume {
                    background: #fef3c7;
                    color: #92400e;
                }
                .transaction-type.refund {
                    background: #dbeafe;
                    color: #1e40af;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(modal);
        }
        
        // 生成交易記錄行
        function generateTransactionRows(transactions) {
            if (!transactions || transactions.length === 0) {
                return '<tr><td colspan="6" style="text-align: center; color: #6b7280;">暫無交易記錄</td></tr>';
            }
            
            return transactions.map(transaction => {
                const typeClass = transaction.type === 'charge' ? 'charge' : 
                                 transaction.type === 'consume' ? 'consume' : 'refund';
                const typeText = transaction.type === 'charge' ? '充值' : 
                                transaction.type === 'consume' ? '消費' : '退款';
                const pointsText = transaction.type === 'consume' ? `-${transaction.points}` : `+${transaction.points}`;
                const moduleText = transaction.module ? getModuleName(transaction.module) : '-';
                
                return `
                    <tr>
                        <td>${transaction.created_at || '-'}</td>
                        <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                        <td>${moduleText}</td>
                        <td>${pointsText}</td>
                        <td>${transaction.balance_after || '-'}</td>
                        <td>${transaction.description || transaction.reason || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // 獲取功能名稱
        function getModuleName(module) {
            const moduleNames = {
                'positioning': '定位顧問',
                'topics': '選題助手',
                'script': '腳本生成'
            };
            return moduleNames[module] || module;
        }
        
        // 關閉點數詳情模態窗口
        function closeCreditDetailsModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // 儲存設定
        function saveSettings() {
            const apiBase = document.getElementById('apiBase').value;
            const adminToken = document.getElementById('adminToken').value;
            
            localStorage.setItem('admin_api_base', apiBase);
            localStorage.setItem('admin_token', adminToken);
            
            alert('設定已儲存');
        }

        // 載入設定
        function loadSettings() {
            const apiBase = localStorage.getItem('admin_api_base') || 'https://aijobvideobackend.zeabur.app';
            const adminToken = localStorage.getItem('admin_token') || '';
            
            document.getElementById('apiBase').value = apiBase;
            document.getElementById('adminToken').value = adminToken;
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 先檢查管理員登入狀態
            const isLoggedIn = await checkAdminLogin();
            if (isLoggedIn) {
                loadSettings();
                loadDashboard();
            }
        });
    </script>
</body>
</html>